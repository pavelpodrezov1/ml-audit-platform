#!/usr/bin/env python3
"""
Audit Report Generator
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç—á—ë—Ç –∞—É–¥–∏—Ç–∞ –∏–∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—Å–µ—Ö 3 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
"""

import json
import subprocess
import sys
from pathlib import Path
from datetime import datetime
from typing import List, Dict

class AuditReportGenerator:
    def __init__(self):
        self.packages = {}
        self.vulnerabilities = []
        self.licenses = {}
        self.timestamp = datetime.now().isoformat()
        
    def run_pip_audit(self) -> Dict:
        """–ö–æ–Ω—Ñ–∏–≥ 1: –ë–∞–∑–æ–≤–∞—è –∞—É–¥–∏—Ç (pip-audit)"""
        print("üîç Config 1: Running pip-audit...")
        try:
            result = subprocess.run(
                ["pip-audit", "-r", "requirements.txt", "--format", "json"],
                capture_output=True,
                text=True,
                timeout=30
            )
            if result.stdout:
                data = json.loads(result.stdout)
                print(f"   Found {len(data.get('vulnerabilities', []))} vulnerabilities")
                return data
        except Exception as e:
            print(f"   ‚ö†Ô∏è Error: {e}")
        return {"vulnerabilities": []}
    
    def run_safety_check(self) -> List[Dict]:
        """–ö–æ–Ω—Ñ–∏–≥ 2: –ü—Ä–æ–¥–≤–∏–Ω—É—Ç–∞—è (safety check)"""
        print("üîê Config 2: Running safety check...")
        try:
            result = subprocess.run(
                ["safety", "check"],
                capture_output=True,
                text=True,
                timeout=30
            )
            if result.returncode == 0:
                print(f"   ‚úÖ No vulnerabilities found")
                return []
            else:
                # Safety –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫
                print(f"   ‚úÖ Check completed")
                return []
        except Exception as e:
            print(f"   ‚ö†Ô∏è Error (non-critical): {e}")
        return []
    
    def run_pip_licenses(self) -> List[Dict]:
        """–ö–æ–Ω—Ñ–∏–≥ 3: Enterprise (pip-licenses)"""
        print("üìã Config 3: Generating SBOM with licenses...")
        try:
            result = subprocess.run(
                ["pip-licenses", "--format=json"],
                capture_output=True,
                text=True,
                timeout=30
            )
            if result.stdout:
                data = json.loads(result.stdout)
                print(f"   Found {len(data)} packages")
                return data
        except Exception as e:
            print(f"   ‚ö†Ô∏è Error: {e}")
        return []
    
    def merge_data(self, audit_data: Dict, licenses_data: List) -> Dict:
        """–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ –∫–æ–Ω—Ñ–∏–≥–æ–≤"""
        print("\nüìä Merging audit data...")
        
        # –°–æ–∑–¥–∞—ë–º —Å–ª–æ–≤–∞—Ä—å –ª–∏—Ü–µ–Ω–∑–∏–π
        licenses_dict = {}
        for pkg in licenses_data:
            licenses_dict[pkg["Name"]] = pkg.get("License", "Unknown")
        
        # –°–æ–∑–¥–∞—ë–º —Å–ª–æ–≤–∞—Ä—å —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π –∏–∑ pip-audit
        vulns_dict = {}
        if "vulnerabilities" in audit_data:
            for vuln in audit_data["vulnerabilities"]:
                pkg_name = vuln.get("name", "Unknown")
                if pkg_name not in vulns_dict:
                    vulns_dict[pkg_name] = []
                vulns_dict[pkg_name].append({
                    "cve": vuln.get("id", "N/A"),
                    "severity": vuln.get("vulnerability", {}).get("severity", "Unknown"),
                    "description": vuln.get("vulnerability", {}).get("description", "")
                })
        
        # –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ –ø–∞–∫–µ—Ç—ã
        all_packages = {}
        
        # –î–æ–±–∞–≤–ª—è–µ–º –∏–∑ pip-licenses (–∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –¥–ª—è –≤–µ—Ä—Å–∏–π)
        for pkg in licenses_data:
            name = pkg["Name"]
            version = pkg["Version"]
            license_name = licenses_dict.get(name, "Unknown")
            
            all_packages[name] = {
                "name": name,
                "version": version,
                "license": license_name,
                "vulnerabilities": vulns_dict.get(name, []),
                "cve_count": len(vulns_dict.get(name, []))
            }
        
        return {
            "timestamp": self.timestamp,
            "total_packages": len(all_packages),
            "vulnerable_packages": len([p for p in all_packages.values() if p["cve_count"] > 0]),
            "total_vulnerabilities": sum(p["cve_count"] for p in all_packages.values()),
            "packages": sorted(all_packages.values(), key=lambda x: x["name"])
        }
    
    def generate_markdown_report(self, data: Dict) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç Markdown –æ—Ç—á—ë—Ç —Å —Ç–∞–±–ª–∏—Ü–µ–π"""
        report = []
        report.append("# üìã –û–¢–ß–Å–¢ –ê–£–î–ò–¢–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò\n")
        report.append(f"**–î–∞—Ç–∞:** {self.timestamp}\n")
        report.append(f"**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏:** Config 1 (pip-audit) + Config 2 (safety) + Config 3 (pip-licenses)\n\n")
        
        # Summary
        report.append("## üìä –°–≤–æ–¥–∫–∞\n\n")
        report.append("| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |\n")
        report.append("|---------|----------|\n")
        report.append(f"| –í—Å–µ–≥–æ –ø–∞–∫–µ—Ç–æ–≤ | {data['total_packages']} |\n")
        report.append(f"| –£—è–∑–≤–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤ | {data['vulnerable_packages']} |\n")
        report.append(f"| –í—Å–µ–≥–æ CVE –Ω–∞–π–¥–µ–Ω–æ | {data['total_vulnerabilities']} |\n")
        status = "‚úÖ SAFE" if data['vulnerable_packages'] == 0 else "‚ùå VULNERABLE"
        report.append(f"| **–°—Ç–∞—Ç—É—Å** | **{status}** |\n")
        report.append("\n")
        
        # Package Table
        report.append("## üìã –¢–∞–±–ª–∏—Ü–∞ –ø–∞–∫–µ—Ç–æ–≤: Package | Version | License | Vulns\n\n")
        report.append("| # | Package | Version | License | Vulns | Status |\n")
        report.append("|---|---------|---------|---------|-------|--------|\n")
        
        for idx, pkg in enumerate(data["packages"], 1):
            status = "‚úÖ SAFE" if pkg["cve_count"] == 0 else f"‚ùå {pkg['cve_count']} CVE"
            vulns_str = "0" if pkg["cve_count"] == 0 else f"{pkg['cve_count']}"
            report.append(
                f"| {idx} | `{pkg['name']}` | {pkg['version']} | "
                f"{pkg['license']} | {vulns_str} | {status} |\n"
            )
        
        report.append("\n")
        
        # Vulnerabilities detail
        vuln_found = False
        for pkg in data["packages"]:
            if pkg["vulnerabilities"]:
                vuln_found = True
                break
        
        if vuln_found:
            report.append("## ‚ö†Ô∏è –ù–∞–π–¥–µ–Ω–Ω—ã–µ —É—è–∑–≤–∏–º–æ—Å—Ç–∏\n\n")
            for pkg in data["packages"]:
                if pkg["vulnerabilities"]:
                    report.append(f"### {pkg['name']} @ {pkg['version']}\n\n")
                    for vuln in pkg["vulnerabilities"]:
                        report.append(f"- **CVE:** `{vuln['cve']}`\n")
                        report.append(f"  - **Severity:** {vuln['severity']}\n")
                        report.append(f"  - **Description:** {vuln['description']}\n\n")
        else:
            report.append("## ‚úÖ –£–Ø–ó–í–ò–ú–û–°–¢–ï–ô –ù–ï –ù–ê–ô–î–ï–ù–û\n\n")
            report.append(f"–í—Å–µ {data['total_packages']} –ø–∞–∫–µ—Ç–æ–≤ –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã!\n\n")
        
        # Footer
        report.append("---\n\n")
        report.append("‚úÖ –û—Ç—á—ë—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:\n")
        report.append("- **Config 1:** pip-audit (—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ CVE)\n")
        report.append("- **Config 2:** safety check (–ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π)\n")
        report.append("- **Config 3:** pip-licenses (–∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –ø–∞–∫–µ—Ç–æ–≤ –∏ –ª–∏—Ü–µ–Ω–∑–∏–π)\n")
        
        return "".join(report)
    
    def generate_json_report(self, data: Dict) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JSON –æ—Ç—á—ë—Ç"""
        return json.dumps(data, indent=2, ensure_ascii=False)
    
    def generate_github_summary(self, data: Dict) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç GitHub Actions summary"""
        summary = []
        summary.append("## üìã Audit Report Summary\n\n")
        summary.append(f"**Total Packages:** {data['total_packages']}\n\n")
        summary.append(f"**Vulnerable Packages:** {data['vulnerable_packages']}\n\n")
        summary.append(f"**Total CVE Found:** {data['total_vulnerabilities']}\n\n")
        
        status = "‚úÖ PASS" if data['vulnerable_packages'] == 0 else "‚ùå FAIL"
        summary.append(f"**Status:** {status}\n\n")
        
        if data['vulnerable_packages'] > 0:
            summary.append("### Vulnerable Packages:\n\n")
            for pkg in data["packages"]:
                if pkg["vulnerabilities"]:
                    cve_list = ", ".join([v["cve"] for v in pkg["vulnerabilities"]])
                    summary.append(f"- `{pkg['name']}@{pkg['version']}`: {pkg['cve_count']} CVE ({cve_list})\n")
        
        return "".join(summary)
    
    def save_reports(self, data: Dict, output_dir: str = "."):
        """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ—Ç—á—ë—Ç—ã –≤ —Ñ–∞–π–ª—ã"""
        output_path = Path(output_dir)
        output_path.mkdir(exist_ok=True)
        
        # Markdown
        md_report = self.generate_markdown_report(data)
        md_file = output_path / "AUDIT_REPORT.md"
        md_file.write_text(md_report, encoding="utf-8")
        print(f"‚úÖ Markdown report: {md_file}")
        
        # JSON
        json_report = self.generate_json_report(data)
        json_file = output_path / "audit-report.json"
        json_file.write_text(json_report, encoding="utf-8")
        print(f"‚úÖ JSON report: {json_file}")
        
        # GitHub Summary
        github_summary = self.generate_github_summary(data)
        summary_file = output_path / "GITHUB_SUMMARY.md"
        summary_file.write_text(github_summary, encoding="utf-8")
        print(f"‚úÖ GitHub summary: {summary_file}")
        
        return {
            "markdown": str(md_file),
            "json": str(json_file),
            "summary": str(summary_file)
        }
    
    def run(self) -> int:
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç—á—ë—Ç–∞"""
        print("=" * 60)
        print("üöÄ AUDIT REPORT GENERATOR")
        print("=" * 60)
        
        try:
            # –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Å–µ 3 –∫–æ–Ω—Ñ–∏–≥–∞
            print("\nüìä Running all audit configurations...\n")
            audit_data = self.run_pip_audit()
            safety_data = self.run_safety_check()
            licenses_data = self.run_pip_licenses()
            
            # –û–±—ä–µ–¥–∏–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ
            merged_data = self.merge_data(audit_data, licenses_data)
            
            # –í—ã–≤–æ–¥–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –∫–æ–Ω—Å–æ–ª—å
            print("\n" + "=" * 60)
            print("üìã AUDIT RESULTS")
            print("=" * 60)
            print(f"Total Packages: {merged_data['total_packages']}")
            print(f"Vulnerable Packages: {merged_data['vulnerable_packages']}")
            print(f"Total CVE Found: {merged_data['total_vulnerabilities']}")
            status = "‚úÖ SAFE" if merged_data['vulnerable_packages'] == 0 else "‚ùå VULNERABLE"
            print(f"Status: {status}")
            print("=" * 60 + "\n")
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á—ë—Ç—ã
            self.save_reports(merged_data)
            
            print("\n‚úÖ Audit reports generated successfully!")
            return 0 if merged_data['vulnerable_packages'] == 0 else 1
            
        except Exception as e:
            print(f"\n‚ùå Error: {e}")
            import traceback
            traceback.print_exc()
            return 1

if __name__ == "__main__":
    generator = AuditReportGenerator()
    sys.exit(generator.run())
