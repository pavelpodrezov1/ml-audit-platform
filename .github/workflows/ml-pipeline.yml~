name: ML Pipeline with Audit

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Security Audit
        run: |
          pip install pip-audit pip-licenses
          pip-audit -r requirements.txt || true
          pip-licenses --format=json > sbom.json
      
      - name: Build Docker image
        run: |
          docker build -t ml-api:${{ github.sha }} .
      
      - name: Clean up containers (before test)
        run: |
          docker stop test-api 2>/dev/null || true
          docker rm test-api 2>/dev/null || true
      
      - name: Test API
        run: |
          docker run -d -p 8000:8000 --name test-api-${{ github.run_id }} ml-api:${{ github.sha }}
          sleep 3
          curl -f http://localhost:8000/health || exit 1
          docker stop test-api-${{ github.run_id }}
          docker rm test-api-${{ github.run_id }}
      
      - name: Clean up (after test)
        if: always()
        run: |
          docker stop test-api-${{ github.run_id }} 2>/dev/null || true
          docker rm test-api-${{ github.run_id }} 2>/dev/null || true

