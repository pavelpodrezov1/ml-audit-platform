# .github/workflows/ml-pipeline.yml
name: ML Pipeline with Audit

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Security Audit
        run: |
          pip install pip-audit pip-licenses
          pip-audit -r requirements.txt || true
          pip-licenses --format=json > sbom.json
      
      - name: Build Docker image
        run: |
          docker build -t ml-api:${{ github.sha }} .
      
      - name: Clean up containers (before test)
        run: |
          docker stop test-api-${{ github.run_id }} 2>/dev/null || true
          docker rm test-api-${{ github.run_id }} 2>/dev/null || true
      
      - name: Test API
        run: |
          # Запускаем на порту 9000 вместо 8000 (избегаем конфликтов)
          docker run -d -p 9000:8000 --name test-api-${{ github.run_id }} ml-api:${{ github.sha }}
          
          echo "Waiting for API to start (10 seconds)..."
          sleep 10
          
          echo "=== Container logs ==="
          docker logs test-api-${{ github.run_id }}
          echo "===================="
          
          echo "Testing health endpoint on port 9000..."
          curl -v http://localhost:9000/health || exit 1
          echo "✅ API test passed!"
      
      - name: Clean up (after test)
        if: always()
        run: |
          docker stop test-api-${{ github.run_id }} 2>/dev/null || true
          docker rm test-api-${{ github.run_id }} 2>/dev/null || true

