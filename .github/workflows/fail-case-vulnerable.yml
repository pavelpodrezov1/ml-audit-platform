name: Fail-Case Testing (Vulnerable Dependencies)

on:
  push:
    branches: [main]
    paths:
      - ".github/workflows/fail-case-vulnerable.yml"
  workflow_dispatch:

jobs:
  fail-case-vulnerable:
    runs-on: ubuntu-latest
    name: "Fail-Case: Test with Vulnerable Packages"
    continue-on-error: true
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Create vulnerable requirements file
        run: |
          cat > vulnerable-requirements.txt << 'EOF'
          # This file intentionally contains vulnerable packages for testing
          requests==2.31.0
          cryptography==3.4.8
          EOF
          
          echo "Created vulnerable requirements file:"
          cat vulnerable-requirements.txt

      - name: Install vulnerable packages
        run: |
          python -m pip install --upgrade pip
          pip install -r vulnerable-requirements.txt
          
          echo ""
          echo "Installed vulnerable packages:"
          pip list | grep -E "requests|cryptography"

      - name: Install security tools
        run: pip install pip-audit safety

      - name: Run pip-audit on vulnerable packages
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "üö® SCANNING VULNERABLE PACKAGES..."
          echo "This should FAIL because of CVEs!"
          echo "=========================================="
          pip-audit -r vulnerable-requirements.txt --desc
          echo ""

      - name: Run safety check
        continue-on-error: true
        run: |
          echo "=========================================="
          echo "üö® RUNNING SAFETY CHECK ON VULNERABLE PACKAGES"
          echo "=========================================="
          safety check --json > fail-case-safety-report.json 2>&1
          cat fail-case-safety-report.json
          echo ""

      - name: Expected failure log
        run: |
          echo "=========================================="
          echo "‚úÖ EXPECTED BEHAVIOR: Vulnerabilities detected!"
          echo "=========================================="
          echo ""
          echo "Summary of detected issues:"
          echo "  ‚ùå requests==2.31.0 - CVE vulnerabilities detected"
          echo "  ‚ùå cryptography==3.4.8 - CVE vulnerabilities detected"
          echo ""
          echo "This workflow demonstrates CORRECT failure detection."
          echo "In production, this would block the deployment."
          echo ""
          echo "To fix: Update to newer versions"
          echo "  pip install --upgrade requests cryptography"

      - name: Upload fail-case report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: fail-case-vulnerable-report
          path: |
            vulnerable-requirements.txt
            fail-case-safety-report.json

