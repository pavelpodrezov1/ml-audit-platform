name: '‚ùå FAIL-CASE: Vulnerable Dependencies Test'

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  fail-case-demo:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      # –®–∞–≥ 1: –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª —Å –£–Ø–ó–í–ò–ú–´–ú–ò –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
      - name: üö® Create vulnerable requirements file
        run: |
          echo "# This file contains VULNERABLE packages for TESTING"
          echo "# DO NOT USE IN PRODUCTION!"
          echo ""
          echo "# VULNERABLE packages:"
          echo "requests==2.31.0  # Has CVE vulnerabilities"
          echo "cryptography==3.4.8  # Old version with known CVEs"
          echo ""
          echo "# Normal packages:"
          cat requirements.txt
          
          # –°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª —Å —É—è–∑–≤–∏–º–æ—Å—Ç—è–º–∏
          cat > requirements-vulnerable.txt << 'EOF'
          # VULNERABLE packages for testing
          requests==2.31.0
          cryptography==3.4.8
          
          # Normal packages
          fastapi
          uvicorn
          scikit-learn
          pandas
          numpy
          joblib
          pydantic
          kaggle
          EOF
          
          echo "‚úÖ Vulnerable requirements file created"
      
      # –®–∞–≥ 2: –ü—ã—Ç–∞–µ–º—Å—è —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —É—è–∑–≤–∏–º—ã–µ –ø–∞–∫–µ—Ç—ã
      - name: üì¶ Install vulnerable packages
        run: |
          python -m pip install --upgrade pip
          
          echo "=========================================="
          echo "Installing vulnerable packages..."
          echo "=========================================="
          
          pip install -r requirements-vulnerable.txt || true
          echo "Installation complete (may have warnings)"
      
      # –®–∞–≥ 3: FAIL TEST - –∑–∞–ø—É—Å–∫–∞–µ–º pip-audit (–î–û–õ–ñ–ï–ù –£–ü–ê–°–¢–¨)
      - name: üîç FAIL TEST: pip-audit on vulnerable packages
        continue-on-error: true
        run: |
          pip install pip-audit
          
          echo "=========================================="
          echo "üö® SCANNING VULNERABLE PACKAGES..."
          echo "This should FAIL because of CVEs!"
          echo "=========================================="
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º pip-audit - –û–ù –£–ü–ê–î–Å–¢
          if pip-audit -r requirements-vulnerable.txt --desc; then
            echo "‚ùå ERROR: pip-audit should have found vulnerabilities!"
            exit 1
          else
            echo "‚úÖ EXPECTED FAILURE: Vulnerabilities detected!"
            echo "This is correct behavior - workflow SHOULD fail"
          fi
      
      # –®–∞–≥ 4: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –Ω–∞—à–ª–æ—Å—å
      - name: üìä Report vulnerabilities
        run: |
          echo "=========================================="
          echo "üìä DETECTED VULNERABILITIES REPORT"
          echo "=========================================="
          
          pip-audit -r requirements-vulnerable.txt --desc > fail-case-audit.txt 2>&1 || true
          
          cat fail-case-audit.txt
      
      # –®–∞–≥ 5: –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
      - name: üí° Suggest fixes
        run: |
          echo "=========================================="
          echo "üí° HOW TO FIX:"
          echo "=========================================="
          
          cat << 'EOF'
          ‚ùå PROBLEMATIC PACKAGES:
          - requests==2.31.0 ‚Üí Should update to latest
          - cryptography==3.4.8 ‚Üí Should update to latest
          
          ‚úÖ SOLUTION:
          - Remove vulnerable versions from requirements.txt
          - Use "pip install --upgrade requests cryptography"
          - Or use: pip install -U -r requirements.txt
          
          ‚úÖ BEST PRACTICE:
          - Use poetry.lock or pip-compile for reproducible builds
          - Regularly update dependencies
          - Use "pip-audit" in CI/CD pipeline
          EOF
      
      # –®–∞–≥ 6: –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç—á–µ—Ç
      - name: üì§ Upload fail-case report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: fail-case-report
          path: |
            requirements-vulnerable.txt
            fail-case-audit.txt

