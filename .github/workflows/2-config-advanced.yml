name: Config 2 - Advanced Audit (Safety + LicenseCheck)

on:
  push:
    branches: [main]
    paths:
      - "requirements.txt"
      - "pyproject.toml"
      - "poetry.lock"
      - "Pipfile"
      - "Pipfile.lock"
      - ".licensecheck.toml"
      - ".github/workflows/2-config-advanced.yml"
  pull_request:
    branches: [main]

jobs:
  config2-advanced-audit:
    runs-on: ubuntu-latest
    name: "Config 2: Safety + LicenseCheck Audit"
    permissions:
      contents: read
      packages: write

    steps:
      # ========== SETUP ==========
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'

      # ========== DETECT MANAGER ==========
      - name: Detect dependency manager
        id: manager
        run: |
          if [ -f "pyproject.toml" ]; then
            echo "type=poetry" >> $GITHUB_OUTPUT
            echo "âœ… Poetry detected"
          elif [ -f "Pipfile" ]; then
            echo "type=pipenv" >> $GITHUB_OUTPUT
            echo "âœ… Pipenv detected"
          else
            echo "type=pip" >> $GITHUB_OUTPUT
            echo "âœ… pip detected"
          fi

      # ========== POETRY FLOW ==========
      - name: "[Poetry] Install Poetry"
        if: steps.manager.outputs.type == 'poetry'
        run: |
          python -m pip install --upgrade pip poetry
          poetry config virtualenvs.in-project true

      - name: "[Poetry] Install dependencies"
        if: steps.manager.outputs.type == 'poetry'
        run: poetry install --no-interaction

      - name: "[Poetry] Install audit tools"
        if: steps.manager.outputs.type == 'poetry'
        run: |
          pip install --upgrade safety licensecheck pip-licenses

      # ========== PIPENV FLOW ==========
      - name: "[Pipenv] Install Pipenv"
        if: steps.manager.outputs.type == 'pipenv'
        run: |
          python -m pip install --upgrade pip pipenv

      - name: "[Pipenv] Install dependencies"
        if: steps.manager.outputs.type == 'pipenv'
        run: pipenv install

      - name: "[Pipenv] Install audit tools"
        if: steps.manager.outputs.type == 'pipenv'
        run: |
          pip install --upgrade safety licensecheck pip-licenses

      # ========== PIP FLOW ==========
      - name: "[pip] Install dependencies"
        if: steps.manager.outputs.type == 'pip'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: "[pip] Install audit tools"
        if: steps.manager.outputs.type == 'pip'
        run: |
          pip install --upgrade safety licensecheck pip-licenses

      # ========== SAFETY CHECK (Vulnerabilities) ==========
      - name: "ðŸ” Safety: Check vulnerabilities"
        run: |
          echo "=========================================="
          echo "ðŸ” SAFETY CHECK - Vulnerability Scan"
          echo "=========================================="
          safety check --json > safety-report.json || true
          cat safety-report.json
          echo ""

      # ========== LICENSE CHECK (Compliance) ==========
      - name: "ðŸ” Verify .licensecheck.toml exists"
        run: |
          echo "=========================================="
          echo "ðŸ” Checking license configuration file"
          echo "=========================================="
          if [ ! -f ".licensecheck.toml" ]; then
            echo "âŒ FATAL: .licensecheck.toml not found!"
            echo ""
            echo "Files in repo:"
            find . -maxdepth 1 -name "*license*" -type f
            exit 1
          fi
          echo "âœ… Found .licensecheck.toml"
          echo ""
          cat .licensecheck.toml
          echo ""

      - name: "âš–ï¸ LicenseCheck: Check forbidden licenses"
        run: |
          echo "=========================================="
          echo "âš–ï¸ LICENSE CHECK - Strategy Validation"
          echo "=========================================="
          set +e
          licensecheck --zero --file .licensecheck.toml
          EXIT_CODE=$?
          set -e
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo ""
            echo "âœ… All licenses are allowed"
          else
            echo ""
            echo "âŒ FORBIDDEN LICENSES DETECTED!"
            echo "Exit code: $EXIT_CODE"
            exit $EXIT_CODE
          fi

      - name: "ðŸ“‹ Generate full license report"
        run: |
          echo "=========================================="
          echo "ðŸ“‹ LICENSE REPORT - All packages"
          echo "=========================================="
          pip-licenses --format=json > licenses-report.json
          pip-licenses
          echo ""

      # ========== UPLOAD REPORTS ==========
      - name: Upload safety report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: safety-report
          path: safety-report.json

      - name: Upload licenses report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: licenses-report
          path: licenses-report.json

      - name: Upload .licensecheck.toml
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: license-config
          path: .licensecheck.toml

