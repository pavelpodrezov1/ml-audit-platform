name: '2Ô∏è‚É£ Config ADVANCED (CI/CD) - safety + licensecheck'

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  advanced-ci-cd:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # –®–∞–≥ 1: SAFETY - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
      - name: üîê AUDIT: safety (Advanced vulnerability scan)
        run: |
          pip install safety
          
          echo "=========================================="
          echo "üîê RUNNING SAFETY SCAN (Advanced)..."
          echo "=========================================="
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º safety —Å JSON –≤—ã–≤–æ–¥–æ–º
          safety check \
            --json \
            --output json > advanced-safety-report.json || true
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
          cat advanced-safety-report.json | python -m json.tool
          
          echo "‚úÖ SAFETY SCAN COMPLETE"
      
      # –®–∞–≥ 2: LICENSECHECK - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
      - name: üìú AUDIT: licensecheck (Strategy-based)
        run: |
          pip install licensecheck
          
          echo "=========================================="
          echo "üìú CHECKING LICENSE STRATEGY..."
          echo "=========================================="
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –Ω–µ—Ç –∑–∞–ø—Ä–µ—â–µ–Ω–Ω—ã—Ö –ª–∏—Ü–µ–Ω–∑–∏–π
          licensecheck --zero \
            --ignore-packages pip,setuptools,wheel
          
          echo "‚úÖ LICENSE STRATEGY CHECK PASSED"
      
      # –®–∞–≥ 3: –°–æ–±–∏—Ä–∞–µ–º Docker —Å —Ç–µ–≥–æ–º
      - name: üê≥ Build Docker image (Advanced)
        run: |
          docker build \
            -t ml-api:advanced-ci-${{ github.sha }} \
            -t ml-api:advanced-latest \
            .
          
          echo "‚úÖ Docker image built with tags"
      
      # –®–∞–≥ 4: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã API
      - name: üß™ API Tests (Advanced)
        run: |
          docker run -d \
            -p 9000:8000 \
            --name test-api-advanced \
            ml-api:advanced-ci-${{ github.sha }}
          
          sleep 10
          
          echo "Testing /health..."
          curl -v http://localhost:9000/health
          
          echo "Testing /predict endpoint..."
          curl -X POST http://localhost:9000/predict \
            -H "Content-Type: application/json" \
            -d '{
              "pclass": 1,
              "sex": 1,
              "age": 30,
              "sibsp": 0,
              "parch": 0,
              "fare": 100,
              "embarked": 2
            }' | python -m json.tool
          
          echo "‚úÖ API TESTS PASSED"
      
      # –®–∞–≥ 5: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π - Dependency Tree
      - name: üìã Dependency Tree
        run: |
          pip install pipdeptree
          
          echo "=========================================="
          echo "üìã DEPENDENCY TREE"
          echo "=========================================="
          
          pipdeptree
      
      - name: üìä Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: advanced-reports
          path: |
            advanced-safety-report.json

