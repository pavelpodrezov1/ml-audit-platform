name: Config 3 - Enterprise (Full)

on:
  push:
    branches: [main, develop]
    paths:
      - "requirements.txt"
      - "train_model.py"
      - "save_model.py"
      - ".github/workflows/3-config-enterprise.yml"
      - "generate_audit_report.py"
      - "Dockerfile"
  pull_request:
    branches: [main, develop]

jobs:
  enterprise-full-audit:
    runs-on: ubuntu-latest
    name: "Audit: Config 3 - fossa-cli + pip-audit ONLY"
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
          cache: 'pip'

      - name: Install project dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          echo "‚úÖ Dependencies installed"
        continue-on-error: false

      - name: Install ONLY fossa-cli and pip-audit
        run: |
          pip install pip-audit
          echo "‚úÖ Installed: pip-audit"
          
          # Install fossa-cli
          echo "Installing fossa-cli..."
          curl -L https://github.com/fossas/fossa-cli/releases/download/v3.8.13/fossa-linux-x64.zip -o fossa.zip
          unzip -o fossa.zip -d /usr/local/bin/
          chmod +x /usr/local/bin/fossa
          fossa --version || echo "‚ö†Ô∏è  fossa-cli installed (may need config)"
          echo "‚úÖ Installed: fossa-cli"
        continue-on-error: false

      - name: Train ML Model
        run: |
          echo "=========================================="
          echo "ü§ñ TRAINING ML MODEL (Titanic)..."
          echo "=========================================="
          python save_model.py
          echo ""
          echo "‚úÖ Model training completed"
          ls -lh models/
        continue-on-error: false

      - name: Run pip-audit (full vulnerability scan)
        run: |
          echo "=========================================="
          echo "üîç FULL AUDIT WITH pip-audit..."
          echo "=========================================="
          pip-audit --desc > config3-pip-audit-full.txt 2>&1
          cat config3-pip-audit-full.txt
          echo ""
        continue-on-error: false

      - name: Run FOSSA CLI for complete scan (licenses + dependencies)
        run: |
          echo "=========================================="
          echo "üìã RUNNING FOSSA CLI (full scan: licenses+deps)..."
          echo "=========================================="
          
          if command -v fossa &> /dev/null; then
            # Try to run FOSSA without authentication (limited mode)
            fossa analyze --skip-upload > config3-fossa-report.txt 2>&1 || true
            
            if [ -f config3-fossa-report.txt ]; then
              cat config3-fossa-report.txt
            fi
            echo ""
            echo "‚úÖ FOSSA scan completed"
          else
            echo "‚ö†Ô∏è  fossa-cli not available in this environment"
            echo "    Run locally: fossa analyze --skip-upload"
          fi
        continue-on-error: true

      - name: Generate SBOM (Software Bill of Materials)
        run: |
          echo "=========================================="
          echo "üìã GENERATING SBOM (from FOSSA / pip)..."
          echo "=========================================="
          
          # FOSSA can export SBOM, but as alternative:
          # We can use pip to list packages for SBOM
          pip list --format=json > config3-sbom-packages.json
          
          echo "‚úÖ SBOM package list generated"
          cat config3-sbom-packages.json | head -30
          echo ""
        continue-on-error: false

      - name: Generate comprehensive audit report
        run: |
          echo "=========================================="
          echo "üìä GENERATING COMPREHENSIVE REPORT..."
          echo "=========================================="
          
          # Create comprehensive report
          {
            echo "# Enterprise Audit Report (Config 3)"
            echo ""
            echo "## pip-audit Full Scan"
            echo '```'
            cat config3-pip-audit-full.txt
            echo '```'
            echo ""
            echo "## Installed Packages (SBOM)"
            echo '```json'
            cat config3-sbom-packages.json
            echo '```'
            echo ""
            if [ -f config3-fossa-report.txt ]; then
              echo "## FOSSA Scan Results"
              echo '```'
              cat config3-fossa-report.txt
              echo '```'
            fi
          } > config3-enterprise-report.md
          
          echo "‚úÖ Comprehensive report generated"
        continue-on-error: false

      - name: Generate Audit Report
        run: |
          echo "Running generate_audit_report.py..."
          python generate_audit_report.py
        continue-on-error: false

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine environment (dev/prod)
        id: env
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "ENV_TAG=prod"
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "ENV_TAG=dev"
          fi

      - name: Build and PUSH Docker image (dev/prod to GHCR)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository }}/ml-api:config3-${{ steps.env.outputs.environment }}-latest
            ghcr.io/${{ github.repository }}/ml-api:config3-${{ steps.env.outputs.environment }}-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Test API endpoints (comprehensive)
        run: |
          docker run -d -p 8000:8000 --name test-api-config3 ghcr.io/${{ github.repository }}/ml-api:config3-${{ steps.env.outputs.environment }}-latest
          sleep 4
          
          echo "=========================================="
          echo "üß™ COMPREHENSIVE API TESTING (Config 3)..."
          echo "=========================================="
          
          echo "Test 1: /health endpoint..."
          HEALTH=$(curl -s http://localhost:8000/health)
          if echo "$HEALTH" | grep -q "healthy"; then
            echo "‚úÖ Health check passed"
          else
            echo "‚ùå Health check failed"
            exit 1
          fi
          
          echo "Test 2: /predict scenario 1 (high class, female, adult)..."
          PRED1=$(curl -s -X POST http://localhost:8000/predict \
            -H "Content-Type: application/json" \
            -d '{"pclass": 1, "sex": 1, "age": 30, "sibsp": 0, "parch": 0, "fare": 100, "embarked": 2}')
          if echo "$PRED1" | grep -q "prediction"; then
            echo "‚úÖ Scenario 1 passed"
          else
            echo "‚ùå Scenario 1 failed"
            exit 1
          fi
          
          echo "Test 3: /predict scenario 2 (low class, male, young)..."
          PRED2=$(curl -s -X POST http://localhost:8000/predict \
            -H "Content-Type: application/json" \
            -d '{"pclass": 3, "sex": 0, "age": 20, "sibsp": 1, "parch": 0, "fare": 8, "embarked": 0}')
          if echo "$PRED2" | grep -q "prediction"; then
            echo "‚úÖ Scenario 2 passed"
          else
            echo "‚ùå Scenario 2 failed"
            exit 1
          fi
          
          echo ""
          echo "=========================================="
          echo "‚úÖ All API tests passed!"
          echo "=========================================="
          
          docker stop test-api-config3 || true
        continue-on-error: false

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: config3-artifacts
          path: |
            models/
            config3-pip-audit-full.txt
            config3-fossa-report.txt
            config3-sbom-packages.json
            config3-enterprise-report.md
            AUDIT_REPORT.md
          if-no-files-found: warn

