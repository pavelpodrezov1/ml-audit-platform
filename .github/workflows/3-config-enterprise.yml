name: '3Ô∏è‚É£ Config ENTERPRISE (Full) - SBOM + pip-audit + pipdeptree'

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  enterprise-full:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # –®–∞–≥ 1: PIP-AUDIT –ø–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç
      - name: üîç FULL AUDIT: pip-audit with descriptions
        run: |
          pip install pip-audit
          
          echo "=========================================="
          echo "üîç FULL AUDIT REPORT (pip-audit)..."
          echo "=========================================="
          
          # –ü–æ–ª–Ω—ã–π –æ—Ç—á–µ—Ç —Å –æ–ø–∏—Å–∞–Ω–∏—è–º–∏
          pip-audit -r requirements.txt --desc > enterprise-audit-full.txt 2>&1 || true
          
          cat enterprise-audit-full.txt
      
      # –®–∞–≥ 2: SBOM Generation (Software Bill of Materials)
      - name: üì¶ SBOM Generation (Software Bill of Materials)
        run: |
          pip install pip-licenses
          
          echo "=========================================="
          echo "üì¶ GENERATING SBOM..."
          echo "=========================================="
          
          # –°–æ–∑–¥–∞—ë–º SBOM –≤ JSON —Ñ–æ—Ä–º–∞—Ç–µ
          pip-licenses --format=json > enterprise-sbom.json
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É SBOM
          echo "SBOM Generated:"
          cat enterprise-sbom.json | python -m json.tool | head -50
          
          # –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞–∫–µ—Ç–æ–≤
          PACKAGE_COUNT=$(cat enterprise-sbom.json | python -c "import sys, json; print(len(json.load(sys.stdin)))")
          echo "Total packages in SBOM: $PACKAGE_COUNT"
      
      # –®–∞–≥ 3: –î–µ—Ä–µ–≤–æ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: üìã Dependency Tree (Full)
        run: |
          pip install pipdeptree
          
          echo "=========================================="
          echo "üìã FULL DEPENDENCY TREE..."
          echo "=========================================="
          
          pipdeptree > enterprise-dependency-tree.txt
          
          # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–∞–∫–µ—Ç—ã
          echo "Main packages:"
          pipdeptree -p fastapi,scikit-learn,pandas,numpy,docker || true
      
      # –®–∞–≥ 4: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π
      - name: üìä Version Report
        run: |
          echo "=========================================="
          echo "üìä INSTALLED VERSIONS REPORT..."
          echo "=========================================="
          
          pip list > enterprise-versions.txt
          
          # –í—ã–¥–µ–ª—è–µ–º –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞–∫–µ—Ç—ã
          echo "Critical packages versions:"
          pip show fastapi scikit-learn pandas numpy uvicorn
      
      # –®–∞–≥ 5: –°–æ–±–∏—Ä–∞–µ–º Docker
      - name: üê≥ Build Docker (Multi-stage)
        run: |
          docker build \
            -t ml-api:enterprise-full-${{ github.sha }} \
            -t ml-api:enterprise-latest \
            --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
            .
          
          echo "‚úÖ Enterprise Docker image built"
      
      # –®–∞–≥ 6: –ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
      - name: üß™ Comprehensive Tests
        run: |
          docker run -d \
            -p 10000:8000 \
            --name test-api-enterprise \
            ml-api:enterprise-full-${{ github.sha }}
          
          sleep 10
          
          echo "Test 1: Health check..."
          curl -v http://localhost:10000/health
          
          echo -e "\n\nTest 2: Model info..."
          curl http://localhost:10000/info || true
          
          echo -e "\n\nTest 3: Prediction with multiple cases..."
          
          # –¢–µ—Å—Ç 1: –û–±—ã—á–Ω—ã–π –ø–∞—Å—Å–∞–∂–∏—Ä
          echo "Case 1: Regular passenger"
          curl -X POST http://localhost:10000/predict \
            -H "Content-Type: application/json" \
            -d '{
              "pclass": 3,
              "sex": 0,
              "age": 20,
              "sibsp": 1,
              "parch": 0,
              "fare": 50,
              "embarked": 1
            }' | python -m json.tool
          
          # –¢–µ—Å—Ç 2: –ë–æ–≥–∞—Ç—ã–π –ø–∞—Å—Å–∞–∂–∏—Ä
          echo -e "\n\nCase 2: Rich passenger"
          curl -X POST http://localhost:10000/predict \
            -H "Content-Type: application/json" \
            -d '{
              "pclass": 1,
              "sex": 1,
              "age": 45,
              "sibsp": 0,
              "parch": 1,
              "fare": 500,
              "embarked": 0
            }' | python -m json.tool
          
          echo -e "\n\n‚úÖ ALL TESTS PASSED"
      
      # –®–∞–≥ 7: –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã
      - name: üì§ Upload all artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: enterprise-full-reports
          path: |
            enterprise-sbom.json
            enterprise-audit-full.txt
            enterprise-dependency-tree.txt
            enterprise-versions.txt

