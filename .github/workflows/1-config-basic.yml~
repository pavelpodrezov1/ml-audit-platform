name: '1Ô∏è‚É£ Config BASIC (PoC) - pip-audit + pip-licenses'

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  basic-poc:
    runs-on: ubuntu-latest
    
    steps:
      # –®–∞–≥ 1: –°–∫–∞—á–∏–≤–∞–µ–º –∫–æ–¥ –∏–∑ GitHub
      - name: üì• Checkout code
        uses: actions/checkout@v3
      
      # –®–∞–≥ 2: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Python 3.11
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      # –®–∞–≥ 3: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # –®–∞–≥ 4: –û–°–ù–û–í–ù–û–ï - AUDIT —Å pip-audit
      - name: üîç AUDIT: pip-audit (Vulnerability Scan)
        run: |
          pip install pip-audit
          
          echo "=========================================="
          echo "üîç SCANNING FOR VULNERABILITIES..."
          echo "=========================================="
          
          # –ó–∞–ø—É—Å–∫–∞–µ–º pip-audit, –µ—Å–ª–∏ –Ω–∞—Ö–æ–¥–∏—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–∏ - –ü–ê–î–ê–ï–¢ —Å exit code 1
          pip-audit -r requirements.txt --desc
          
          echo "‚úÖ NO VULNERABILITIES FOUND"
      
      # –®–∞–≥ 5: –û–°–ù–û–í–ù–û–ï - LICENSE CHECK —Å pip-licenses
      - name: üìú AUDIT: pip-licenses (License Check)
        run: |
          pip install pip-licenses
          
          echo "=========================================="
          echo "üìú CHECKING LICENSES..."
          echo "=========================================="
          
          # –°–æ–∑–¥–∞—ë–º JSON –æ—Ç—á–µ—Ç
          pip-licenses --format=json > basic-licenses.json
          
          # –í—ã–≤–æ–¥–∏–º –∫—Ä–∞—Å–∏–≤—É—é —Ç–∞–±–ª–∏—Ü—É
          pip-licenses --format=markdown
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –æ–ø–∞—Å–Ω—ã–µ –ª–∏—Ü–µ–Ω–∑–∏–∏ (GPL, AGPL)
          if grep -q "GPL" basic-licenses.json; then
            echo "‚ö†Ô∏è  WARNING: GPL license detected!"
          fi
      
      # –®–∞–≥ 6: –°–æ–±–∏—Ä–∞–µ–º Docker –æ–±—Ä–∞–∑
      - name: üê≥ Build Docker image
        run: |
          docker build -t ml-api:basic-poc-${{ github.sha }} .
          echo "‚úÖ Docker image built successfully"
      
      # –®–∞–≥ 7: –ó–∞–ø—É—Å–∫–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º
      - name: ‚úÖ Test API (Health check)
        run: |
          echo "Starting container..."
          docker run -d \
            -p 8000:8000 \
            --name test-api-basic \
            ml-api:basic-poc-${{ github.sha }}
          
          echo "Waiting for API to start..."
          sleep 10
          
          echo "Testing /health endpoint..."
          curl -v http://localhost:8000/health
          
          echo "‚úÖ BASIC CONFIG - ALL TESTS PASSED"
      
      # –®–∞–≥ 8: –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç—ã
      - name: üìä Upload artifacts (reports)
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: basic-reports
          path: |
            basic-licenses.json

