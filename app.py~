from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
import joblib
import json
import numpy as np
from typing import List
import logging

# Настройка логирования
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Инициализация FastAPI
app = FastAPI(
    title="Titanic ML Model API",
    description="API для предсказания выживаемости на Titanic",
    version="1.0.0"
)

# Загружаем модель и scaler при запуске
model = None
scaler = None
model_info = None

@app.on_event("startup")
async def load_model():
    """Загружаем модель при запуске приложения"""
    global model, scaler, model_info
    try:
        model = joblib.load('models/titanic_model.pkl')
        scaler = joblib.load('models/titanic_scaler.pkl')
        with open('models/model_info.json', 'r') as f:
            model_info = json.load(f)
        logger.info("✓ Модель загружена успешно")
    except Exception as e:
        logger.error(f"✗ Ошибка при загрузке модели: {e}")
        raise

# Определяем схему для входных данных
class PassengerData(BaseModel):
    pclass: int  # 1, 2 или 3
    sex: int     # 0 для male, 1 для female
    age: float
    sibsp: int   # количество братьев/сестер
    parch: int   # количество родителей/детей
    fare: float
    embarked: int  # 0 для S, 1 для C, 2 для Q

class PredictionResponse(BaseModel):
    prediction: int  # 0 = не выжил, 1 = выжил
    probability: float
    message: str

# Эндпоинты API

@app.get("/")
async def root():
    """Корневой эндпоинт"""
    return {
        "message": "Titanic ML Model API",
        "version": "1.0.0",
        "docs": "/docs"
    }

@app.get("/health")
async def health_check():
    """Проверка здоровья сервиса"""
    return {
        "status": "healthy",
        "model_loaded": model is not None,
        "model_info": model_info
    }

@app.post("/predict", response_model=PredictionResponse)
async def predict(passenger: PassengerData):
    """
    Предсказывает выживаемость пассажира
    
    Пример использования:
    ```json
    {
        "pclass": 1,
        "sex": 1,
        "age": 30,
        "sibsp": 0,
        "parch": 0,
        "fare": 100,
        "embarked": 0
    }
    ```
    """
    try:
        if model is None:
            raise HTTPException(status_code=503, detail="Model not loaded")
        
        # Подготавливаем данные
        X = np.array([[
            passenger.pclass,
            passenger.sex,
            passenger.age,
            passenger.sibsp,
            passenger.parch,
            passenger.fare,
            passenger.embarked
        ]])
        
        # Масштабируем
        X_scaled = scaler.transform(X)
        
        # Предсказываем
        prediction = model.predict(X_scaled)
        probabilities = model.predict_proba(X_scaled)
        
        # Вероятность выживания (класс 1)
        survival_probability = float(probabilities)
        
        # Формируем сообщение
        message = f"Пассажир {'выжил' if prediction == 1 else 'не выжил'} (уверенность: {survival_probability:.2%})"
        
        return PredictionResponse(
            prediction=int(prediction),
            probability=survival_probability,
            message=message
        )
    
    except Exception as e:
        logger.error(f"Ошибка при предсказании: {e}")
        raise HTTPException(status_code=400, detail=str(e))

@app.get("/model-info")
async def get_model_info():
    """Возвращает информацию о модели"""
    return model_info

if __name__ == "__main__":
    import uvicorn
    uvicorn.run(app, host="0.0.0.0", port=8000)

